<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<style>
.main-container{
	width: 100%;
}
.wf-chat-left{
	height: 100%;
	min-height: auto;
	width: 35%;
}
.wf-chat-body{
	height: 100%;
	min-height: auto;
}
.wf-mail-right{
	height: 100%;
	min-height: auto;
}
.wf-mail-wrap{
	height: 100%;
}
.wf-content-area{
	height: 100%;
}
.chat-content{
	height: 80%;
	overflow: scroll;
}
.comment-area{
	padding: 10px 0px 10px;
}
.wf-chat-body .comment-area{
	padding: 10px 0px 10px;
}
</style>
<script>
let realSize = window.innerWidth;
let realHeight = window.innerHeight;
<%-- let empNo = <%=session.getAttribute("empNo")%> --%>
let empNm = "";
let chatRoomNo = "";
let empNo = ${empNo}

$("body").css("width",realSize)
window.addEventListener("resize", function() {
	realSize = window.innerWidth;
	realHeight = window.innerHeight;
	$("body").css("width",realSize)
	$("body").css("height",realHeight)
})

$("header").html("")
$("header").css("height","0px")
$("aside").html("")
$("aside").css("width","0px")

$.ajax({
	url:"/chat/getEmp",
	data:{"empNo":empNo},
	type:"get",
	success:function(res){
		empNm = res.empNm
	}
})


getChatRoomList()
// ë‚´ ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
function getChatRoomList(){
	$.ajax({
		url:"/chat/getChatRoom",
		data:{"empNo":empNo},
		type:"get",
		success:function(res){
			let str = "";
			str += `<div class="wf-chat-list">
					    <span class="txt">
				        <i class="xi-wechat"></i>
				        ALL MESSAGE
				    </span>`
			$.each(res,function(i,v){
				str += `<div class="wf-chat-box myChatRoom" idx="\${v.chatRoomNo}">
							<div class="chat-img">
				            	<img src="/resources/img/icon/avatar.png">
					        </div>
					        <div class="chat-txt">
					            <p class="chat-name">\${v.chatRoomNm}</p>
					            <p class="chat-txt"></p>
					        </div>
					        <div class="chat-side">
					            <p class="chat-date"></p>
					            <span class="fw-alarm-badge">2</span>
					        </div>
				        </div>`
			})
			
			str += `</div>`
			
			$(".wf-chat-list").html(str)
			$.each(res,function(i,v){
				// ë§ˆì§€ë§‰ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°
				$.ajax({
					url:"/chat/getChatRoomLastChat",
					data:{"chatRoomNo":v.chatRoomNo},
					type:"get",
					success:function(res){
						$(`.myChatRoom[idx=\${v.chatRoomNo}] .chat-date`).html(res.formatDate.split("_")[1])
						if(res.mssageCn.length > 8){
							$(`.myChatRoom[idx=\${v.chatRoomNo}] p[class=chat-txt]`).html(res.mssageCn.substr(0,8) + "...");
						}else{
							$(`.myChatRoom[idx=\${v.chatRoomNo}] p[class=chat-txt]`).html(res.mssageCn);
						}
					}
				})
				
			})
			
			
			
		}
	})
}

$(function(){
	// ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œì˜ ê¸°ëŠ¥
	$(document).on("click",".myChatRoom",function(){
		c_chatWin.innerHTML = "";
		chatRoomNo = $(this).attr("idx")
		// ì›¹ì†Œì¼“ ì—°ê²°
		connect(chatRoomNo);
		// ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ í´ë¦­ì‹œ ì˜†ì— ì±„íŒ…ë°© í™”ë©´ ë„ìš°ê¸°
		$.ajax({
			url:"/chat/getChat",
			data:{"chatRoomNo":chatRoomNo},
			type:"get",
			success:function(res){
				console.log("ì±„íŒ…ë‚´ì—­:",res)
				let str = "";
				$.each(res,function(i,v){
					if(v.empNo == empNo){
						str += `<div class="user mine">
								    <div class="chat-user-info">
								        <div class="chat-img">
								            <img src="/resources/img/icon/avatar.png">
								        </div>
								        <p class="chat-name">\${v.empNm}</p>
								        <p class="chat-date">\${v.formatDate}</p>
								    </div>
								    <div class="chat-txt">
								        \${v.mssageCn}
								    </div>
								</div>`
					}else{
						str += `<div class="user you">
						    <div class="chat-user-info">
						        <div class="chat-img">
						            <img src="/resources/img/icon/avatar.png">
						        </div>
						        <p class="chat-name">\${v.empNm}</p>
						        <p class="chat-date">\${v.formatDate}</p>
						    </div>
						    <div class="chat-txt">
						        \${v.mssageCn}
						    </div>
						</div>`
					}
					
				})
				
				c_chatWin.innerHTML = str
				
				c_chatWin.scrollTop = c_chatWin.scrollHeight;
				
			}
		})
		
	})	
	
	$("#getEmpList").on("click",function(){
		let param = $("#cc").val()
		$.ajax({
			url:"/chat/getEmpList",
			data:{"param":param},
			type:"get",
			success:function(res){
				console.log("res:",res)
				let str = "";
				$.each(res,function(i,v){
					str += `<div style="overflow:scroll;">
								<div class="wf-flex-box">
									<div style="width: 10%;">
										<span class="checkbox-radio-custom">
			                                <input type="checkbox" name="chck" id="chck\${i}" value="\${v.empNo}">
			                                <label for="chck\${i}"></label>
		                            	</span>
									</div>
									<div style="width: 35%;">
										<p class="heading1">\${v.empNm}</p>
									</div>
									<div style="width: 35%;">
										<p class="heading1">\${v.deptNm}</p>
									</div>
									<div style="width: 35%;">
										<p class="heading1">\${v.position}</p>
									</div>
								</div>
							</div>`
				})
				$(".wf-chat-detail-list").html(str);
			}
			
		})
		
	})
	
	
	/* $("#insert-new-chatRoom").on("click",function(){
		let newEmpList = []
		
		$.ajax({
			url:"/chat/addNewChatRoom",
			data:{"chatRoomNo":chatRoomNo},
			type:"get",
			success:function(res){
				
			}
			
		})
		
	}) */





let myId = "";
let sockets = [];
let webSocket; // í˜ì´ì§€ ë°”ë€Œë©´ ë³€ìˆ˜ê°€ ì‚¬ë¼ì§„ë‹¤ëŠ” ì‚¬ì‹¤ì— ì£¼ëª©í•  í•„ìš”ê°€ ìˆìŒ
myId = empNo//f_ranID();
const c_chatWin = document.querySelector(".chat-content");
const c_message = document.querySelector("#chat-input");		
const c_send = document.querySelector(".chat-send");
const c_exit = document.querySelector(".xi-log-out");


// ì±„íŒ… ë³´ë‚´ê¸°
c_send.addEventListener("click", function(){
	send(chatRoomNo);
});

// ì—°ê²° ëŠê¸°
c_exit.addEventListener("click", function () {
	disconnect();
}); 
	

//ì—°ê²°
function connect(chatRoomNo) {
	
	let exists = sockets.some(function(socket) {
        return socket.chatRoomNo == chatRoomNo;
    });

    if (exists) {
        return; // ì´ë¯¸ ì¡´ì¬í•˜ë©´ í•¨ìˆ˜ ì¢…ë£Œ
    }
	webSocket = new WebSocket("ws://192.168.146.64:80/ws-chat?chatRoomNo="+chatRoomNo); // End Point
	webSocket.chatRoomNo = chatRoomNo;
	webSocket.onopen = function(event){
		fOpen(chatRoomNo,webSocket)
	} // ë¡œê·¸ì¸ í–ˆì„ ê²½ìš°ì— ì†Œì¼“ ì ‘ì†
	
	webSocket.onmessage = fMessage;
	sockets.push(webSocket);
	
}
	
	
	

//ì—°ê²° ì‹œ
function fOpen(chatRoomNo, socket) {
	socket.send(myId + "ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.");	
	console.log("open")
}

function send(chatRoomNo) {  // ì›¹ì†Œì¼“ ë©”ì„¸ì§€ ì „ì†¡
	let msg = c_message.value;	// ì‹¤í—˜í•˜ëŠ” ê³³ì—ì„œëŠ” c_messageì§€ë§Œ ë‹¤ë¥¸ê³³ì—ì„œëŠ” ë©”ì„¸ì§€ ë‚´ìš©ì„ ë”°ë¡œ ì ì–´ì¤˜ì•¼ í•¨
	// í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ ê°€ì ¸ì˜¤ê¸°
	let currentDate = new Date();

	// ì›”ê³¼ ì¼ì´ í•œ ìë¦¬ ìˆ«ìì¸ ê²½ìš° ì•ì— 0ì„ ì¶”ê°€í•˜ì—¬ ë‘ ìë¦¬ë¡œ í‘œì‹œ
	let month = ('0' + (currentDate.getMonth() + 1)).slice(-2);
	let day = ('0' + currentDate.getDate()).slice(-2);

	// ì‹œê°„ì´ í•œ ìë¦¬ ìˆ«ìì¸ ê²½ìš° ì•ì— 0ì„ ì¶”ê°€í•˜ì—¬ ë‘ ìë¦¬ë¡œ í‘œì‹œ
	let hours = ('0' + currentDate.getHours()).slice(-2);
	let minutes = ('0' + currentDate.getMinutes()).slice(-2);

	// yyyy-MM-dd hh:mm í˜•ì‹ìœ¼ë¡œ ë‚ ì§œì™€ ì‹œê°„ì„ í‘œì‹œ
	let formattedDateTime = currentDate.getFullYear() + '-' + month + '-' + day + ' ' + hours + ':' + minutes;


	$.each(sockets,function(i,socket) {
		// ì›¹ì†Œì¼“ì¤‘ì—ì„œ í˜„ì¬ ì±„íŒ…ë°©ì—ë§Œ ë³´ëƒ„
        if (socket.chatRoomNo == chatRoomNo) {
            socket.send(myId + ":" + empNm + ":" + formattedDateTime + ":" + msg);
            
            $.ajax({
            	url:"/chat/addChat",
            	data:{
            		"chatRoomNo":chatRoomNo,
            		"empNo":myId,
            		"content":msg
            	},
            	type:"get",
            	success:function(res){
            		$(`.myChatRoom[idx=\${chatRoomNo}] .chat-date`).html(formattedDateTime.split(" ")[1])
            		if(msg.length > 8){
	            		$(`.myChatRoom[idx=\${chatRoomNo}] p[class=chat-txt]`).html(msg.substr(0,8)+"...")
            		}else{
	            		$(`.myChatRoom[idx=\${chatRoomNo}] p[class=chat-txt]`).html(msg)
            		}
            	}
            })
            
        }
    });
    c_message.value = "";
}

function fMessage() {
	let data = event.data;
	// ì‚¬ì›ë²ˆí˜¸
	let data1 = data.split(":")[0]
	// ì‚¬ì›ì´ë¦„
	let data2 = data.split(":")[1]
	// í˜„ì¬ ë‚ ì§œ
	let data3 = data.split(":")[2]
	// ë©”ì„¸ì§€
	let data4 = data.split(":")[4]
	// ì±„íŒ…ë£¸ì´ í˜„ì¬ ìì‹ ì´ ë³´ê³ ìˆëŠ” ì±„íŒ…ë£¸ì—ë§Œ ë°ì´í„° ì ìš©
	
	
	if(event.currentTarget.chatRoomNo == chatRoomNo){
		c_chatWin.scrollTop = c_chatWin.scrollHeight;
		if(data.substr(-7,7) == "ì ‘ì†í–ˆìŠµë‹ˆë‹¤."){
			c_chatWin.innerHTML += `<div style="text-align:center">\${data}</div>`
		}else if(data1 == myId){
			c_chatWin.innerHTML += `<div class="user mine">
					    <div class="chat-user-info">
					        <div class="chat-img">
					            <img src="/resources/img/icon/avatar.png">
					        </div>
					        <p class="chat-name">\${data2}</p>
					        <p class="chat-date">\${data3}</p>
					    </div>
					    <div class="chat-txt">
					        \${data4}
					    </div>
					</div>`
		}else{
			c_chatWin.innerHTML += `<div class="user you">
			    <div class="chat-user-info">
			        <div class="chat-img">
			            <img src="/resources/img/icon/avatar.png">
			        </div>
			        <p class="chat-name">\${data2}</p>
			        <p class="chat-date">\${data3}</p>
			    </div>
			    <div class="chat-txt">
			        \${data4}
			    </div>
			</div>`
		}
	}
}


function disconnect() { // ì›¹ì†Œì¼“ ì¢…ë£Œ
	webSocket.send(myId + "ë‹˜ì´ ì ‘ì†ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤");
	webSocket.close();
}
})
</script>

<div class="wf-main-container">
	<!-- =============== body ì‹œì‘ =============== -->
	<!-- =============== ìƒë‹¨íƒ€ì´í‹€ì˜ì—­ ì‹œì‘ =============== -->
	<!-- <div class="wf-tit-wrap">
	    <h1 class="page-tit">
	        <i class="xi-mail"></i>
	        ì „ì²´ë©”ì¼
	        <span class="txt-style1 mg-l">1/51</span>
	    </h1>
	    <div class="side-util">
	        <button type="button" class="btn3">ì‚­ì œ</button>
	    </div>
	</div> -->
	<!-- =============== ìƒë‹¨íƒ€ì´í‹€ì˜ì—­ ë =============== -->
	<!-- =============== ì»¨í…ì¸  ì˜ì—­ ì‹œì‘ =============== -->
	
	<div class="wf-mail-wrap">
	    <div class="wf-content-area wf-chat-left">
	        <button type="button" class="btn5 mail-btn" modal-id="modal-new-chat">ì±„íŒ…ë°© ìƒì„±</button>
	
	        <!-- ì±„íŒ… ëª©ë¡ ì‹œì‘ -->
	<div class="wf-chat-list">
	    <span class="txt">
	        <i class="xi-wechat"></i>
	        ALL MESSAGE
	    </span>
	
	    <!-- ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ë•Œ -->
	<!-- <div class="no-chat">
	    ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì±„íŒ…ë°©ì„ ìƒì„±í•´ë³´ì„¸ìš”!
	</div> -->
	
	<!-- ì±„íŒ… ëª©ë¡ -->
	    <div class="wf-chat-box">
	        <div class="chat-img">
	            <img src="/img/icon/avatar.png">
	        </div>
	        <div class="chat-txt">
	            <p class="chat-name">ì±„íŒ…ë°© ì´ë¦„</p>
	            <p class="chat-txt">ë¯¼ì¤€ì•„ ì–´ë””ë‹ˆ? ğŸ˜Š</p>
	        </div>
	        <div class="chat-side">
	            <p class="chat-date">14:00</p>
	            <span class="fw-alarm-badge">2</span>
	        </div>
	    </div>
	
	
	    <div class="wf-chat-box">
	        <div class="chat-img">
	            <img src="/img/icon/avatar.png">
	        </div>
	        <div class="chat-txt">
	            <p class="chat-name">ì´ì†Œë§, í™©ì§€ì›, ì‹ ì„±ìš°</p>
	            <p class="chat-txt">ì‚¬ì—…ê³„íšì„œ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
	        </div>
	        <div class="chat-side">
	            <p class="chat-date">05:00</p>
	            <span class="fw-alarm-badge">5</span>
	        </div>
	    </div>
	
	</div>
	<!-- ì±„íŒ… ëª©ë¡ ë-->
	</div>
	
	<div class="wf-mail-right">
	    <div class="wf-content-area">
	        <!-- ì±„íŒ…ë°© ì‹œì‘-->
	<div class="wf-chat-body">
	    <!-- ì±„íŒ…ë°© ìƒë‹¨ (í†¡ëª…) -->
	<div class="chat-top">
	    <div class="chat-name">ìµœí”„ë‹¨í†¡</div>
	    <span class="chat-status-active">ì ‘ì†ì¤‘</span>
	    <!-- <span class="chat-status-inactive">ë¯¸ì ‘ì†ì¤‘</span> -->
	    <div class="chat-util">
	        <button type="button" modal-id="modal-chat-modify">
	            <i class="xi-pen"></i>
	        </button>
	        <button type="button">
	            <i class="xi-info"></i>
	        </button>
	        <button type="button">
	            <i class="xi-log-out"></i>
	        </button>
	    </div>
	</div>
	<!-- chat-content -->
	<div class="chat-content">
	</div>
	
	<!-- ì±„íŒ… ì…ë ¥ì°½ -->
	    <div class="comment-area">
	        <div class="input-wrap">
	            <span class="user-thumb">
	                <img src="resources/img/icon/avatar.png" alt="ì˜ˆì‹œì´ë¯¸ì§€">
	            </span>
	            <input type="text" id="chat-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
	            <button type="button" class="btn5"><i class="xi-attachment"></i></button>
	            <button class="btn4 chat-send">ë³´ë‚´ê¸°</button>
	        </div>
	    </div>
	</div>
	<!-- ì±„íŒ…ë°© ë-->
	        </div>
	    </div>
	</div>
<!-- =============== ì»¨í…ì¸  ì˜ì—­ ë =============== -->
<!-- =============== body ë =============== -->
<div class="modal" id="modal-new-chat">
    <div class="modal-cont">
        <h1 class="modal-tit">ëŒ€í™”ìƒëŒ€ ì„ íƒ</h1>
        <div class="modal-content-area">
            <ul class="wf-insert-form2 vertical">
                <li>
                    <label for="cc">ì§ì› ê²€ìƒ‰</label>
                    <div>
                        <div class="wf-flex-box">
                            <input type="text" id="cc" placeholder="ì§ì›ì„ ê²€ìƒ‰í•˜ì„¸ìš”">
                            <button type="button" id="getEmpList" class="btn4">
                                <i class="xi-search"></i>
                            </button>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="wf-chat-detail-list">
                        <span class="txt">ëŒ€í™”ìƒëŒ€</span>
                        <div class="no-data-box">ì„ íƒëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        <!-- <div class="wf-grid-box">
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">ì´í˜„ì¥</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">ì–‘ì—°ì£¼</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">ì´ì†Œë§</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">í™©ì§€ì›</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                        </div> -->
                    </div>
                </li>
            </ul>
        </div>

        <div class="modal-btn-wrap">
            <button class="btn2">í™•ì¸</button>
        </div>

        <button class="close-btn"></button>
    </div>
</div>

<div class="modal" id="modal-chat-modify">
    <div class="modal-cont">
        <h1 class="modal-tit">ìµœí”„ ë‹¨í†¡(ì—¬ê¸°ì— í†¡ë°© ì´ë¦„ì´ ë‚˜ì˜¤ê²Œ)</h1>
        <div class="modal-content-area">
            <ul class="wf-insert-form2 vertical">
                <li>
                    <label for="cc">ì´ë¦„ ë³€ê²½</label>
                    <div>
                        <input type="text" id="cc" placeholder="í†¡ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                    </div>
                </li>
                <li>
                    <div class="wf-chat-detail-list">
                        <span class="txt">ëŒ€í™”ìƒëŒ€</span>
                        <div class="wf-grid-box">
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">ì´í˜„ì¥</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">ì–‘ì—°ì£¼</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">ì´ì†Œë§</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                            <div class="chat-one">
                                <div class="img-wrap">
                                    <img src="/img/icon/avatar.png">
                                </div>
                                <p class="data">í™©ì§€ì›</p>
                                <p class="data">ê°œë°œíŒ€</p>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="modal-btn-wrap">
            <button class="btn2">í™•ì¸</button>
        </div>

        <button class="close-btn"></button>
    </div>
</div>
</div>