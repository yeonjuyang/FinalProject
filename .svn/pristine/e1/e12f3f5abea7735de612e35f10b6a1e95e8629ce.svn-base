<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team1.workforest.board.notice.mapper.NoticeMapper">
	
	<sql id="where">
		
		
		<!-- 검색어가 있는 경우  -->
		<if test="keyword!=null and keyword!=''">
			<if test="searchOption=='title'">
				  AND NOTICE_BRD_SJ LIKE '%' || #{keyword} || '%'
				  <if test="brdCd!=null and brdCd !=''">
				  AND NOTICE_BRD_SE_CD = #{brdCd}
				  </if>
			</if>
			<if test="searchOption=='titlecontent'">
		   		AND (NOTICE_BRD_CN LIKE '%' || #{keyword} || '%' OR  NOTICE_BRD_SJ LIKE '%' || #{keyword} || '%')
		   		<if test="brdCd!=null and brdCd !=''">
				  AND NOTICE_BRD_SE_CD = #{brdCd}
				</if>		
		   </if>
		   <if test="searchOption=='empNm'">
				AND EMP_NM LIKE '%' || #{keyword} || '%'
				<if test="brdCd!=null and brdCd !=''">
				 AND NOTICE_BRD_SE_CD = #{brdCd}
				 </if>	
			</if>
		</if>
		
		<!-- 검색어 없이 선택 시 -->
		<if test="keyword==null or keyword==''">
		 	<if test="brdCd != null and brdCd !=''">
			AND NOTICE_BRD_SE_CD = #{brdCd}
			</if>
		</if>
		
		
	</sql>
	
	
	
	<!-- 검색한 키워드 행 수  -->
	<select id="getkeywordTotal" parameterType="HashMap" resultType="int">
		SELECT  COUNT(*)
		FROM NOTICE_BOARD A, EMPLOYEE B 
		WHERE 
        A.EMP_NO = B.EMP_NO
        <include refid="where"></include>
        
	</select>
	
	
	<!-- 공지게시판 리스트 및 페이징 -->
	<select id="list" parameterType="hashMap" resultType="noticeBoardVO">
	WITH T AS (
    SELECT ROW_NUMBER() OVER(ORDER BY CASE WHEN FIXING_END_DATE IS NULL THEN 1 ELSE 0 END) RNUM,
           F.NOTICE_BRD_NO,
           A.EMP_NM,
           F.NOTICE_BRD_SE_CD,
           B.CMMN_CD_NM,
           F.NOTICE_BRD_CN,
           F.NOTICE_BRD_SJ,
           F.FIXING_END_DATE,
           F.WRITNG_DATE,
           F.RDCNT
    FROM (
        SELECT   NOTICE_BRD_NO,
                 EMP_NO,
                 NOTICE_BRD_SE_CD,
                 NOTICE_BRD_CN,
                 NOTICE_BRD_SJ,
                 WRITNG_DATE,
                 FIXING_END_DATE,
                 RDCNT
        FROM     NOTICE_BOARD
	        ORDER BY TO_NUMBER(NOTICE_BRD_NO) DESC
	    ) F,
	    EMPLOYEE A,
	    COMMON_CODE B
	    WHERE F.EMP_NO = A.EMP_NO
	    AND F.NOTICE_BRD_SE_CD = B.CMMN_CD
	    AND B.CMMN_CD_GROUP = 'BRD001'
	    <include refid="where"></include>
			)
		SELECT *
		FROM T
		 WHERE T.RNUM BETWEEN (#{currentPage}* 10) - (10 - 1) AND (#{currentPage}* 10)
		ORDER BY RNUM
	</select>
	
	<!-- 조회수 증가 -->
	<update id="noticeView" parameterType="String">
		UPDATE NOTICE_BOARD
		SET
		RDCNT = RDCNT + 1
		WHERE 
		NOTICE_BRD_NO = #{noticeBrdNo}
	</update>
	
	
	<!-- 업로드한 파일 번호 -->
	<select id="attachmnflNo" resultType="String">
	SELECT NVL(MAX(TO_NUMBER(ATCHMNFL_NO)), 0) FROM ATTACHED_FILE
	</select>
	
	<!-- 파일 입출력 -->
	<insert id="insertAttachedFile" parameterType="attachedFileVO">
		INSERT INTO ATTACHED_FILE
		VALUES(
		#{atchmnflNo}
		,SEQ_ATTEND.NEXTVAL
		,#{atchmnflNm}
		,#{atchmnflOriginNm}
		,#{atchmnflSize}
		,''
		,#{atchmnflUrl}
		)
	</insert>
	
	
	<insert id="createNotice" parameterType="noticeBoardVO">
	INSERT INTO NOTICE_BOARD
		VALUES(
		(SELECT NVL(MAX(TO_NUMBER(NOTICE_BRD_NO)), 0)+1 FROM NOTICE_BOARD)
		,#{empNo}
		,#{noticeBrdSj}
		,SYSDATE
		,0
		,''
        ,#{noticeBrdSeCd}
        ,TO_CHAR(TO_DATE(#{fixingEndDate}, 'YYYY-MM-DD'), 'YYYYMMDD')
		,#{noticeBrdCn}
		,(SELECT MAX(TO_NUMBER(ATCHMNFL_NO)) FROM ATTACHED_FILE)
		)
	</insert>
	
	<insert id="createNoticeNoFile" parameterType="noticeBoardVO">
	INSERT INTO NOTICE_BOARD
		VALUES(
		(SELECT NVL(MAX(TO_NUMBER(NOTICE_BRD_NO)), 0)+1 FROM NOTICE_BOARD)
		,#{empNo}
		,#{noticeBrdSj}
		,SYSDATE
		,0
		,''
        ,#{noticeBrdSeCd}
        ,TO_CHAR(TO_DATE(#{fixingEndDate}, 'YYYY-MM-DD'), 'YYYYMMDD')
		,#{noticeBrdCn}
		,''
		)
	</insert>
	
	<select id="detail" parameterType="String" resultType="noticeBoardVO">
	SELECT 
	     A.NOTICE_BRD_NO
	    ,A.NOTICE_BRD_SJ
	    ,A.WRITNG_DATE
	    ,A.RDCNT
	    ,A.NOTICE_BRD_CN
	    ,A.ATCHMNFL_NO
	    ,A.EMP_NO
	    ,B.EMP_NM
	FROM
	     NOTICE_BOARD A 
	    ,EMPLOYEE B
	WHERE 
	    A.EMP_NO = B.EMP_NO
	    AND
	    A.NOTICE_BRD_NO= #{noticeBrdNo}
	</select>
	
	
	<!-- 상세 게시판 파일 목록 -->
	<select id="noticeAtchList" parameterType="String" resultType="attachedFileVO">
	SELECT 
		  ATCHMNFL_NO
		, ATCHMNFL_NM
		, ATCHMNFL_ORIGIN_NM
		, ATCHMNFL_SIZE
		, ATCHMNFL_DWLD_DATE
		, ATCHMNFL_URL
	FROM 
		ATTACHED_FILE
	WHERE 
		ATCHMNFL_NO = #{atchmnflNo}
	</select>
	
	
	
	
	
	
	
	
</mapper>