// ajax 요청 결과 캐싱을 위한 flag 변수
let flag = false;

$(function () {

	getTabData1('tab1');
	getTabData2('tab2');
	getTabData3('tab3');
	getTabData4('tab4');
	getTabData5('tab5');
	//getTabData4('tab4');
	
	$('.tab-btn').on('click', function () {
	    let tab = $(this).data('tab');
	
        //if (!flag) {
        //    getTabData(tab);
         //   flag = true;
        //}
	});
	
	// 파라미터별 화면 출력
	let paramOriginal = window.location.search;
	let param = paramOriginal.slice(-1);
	
	switch(param){
		case "1": // 대기
			$('[data-tab="tab1"]').addClass('active').siblings('[data-tab^="tab"]').removeClass('active');
			break;
		case "2": // 진행
			$('[data-tab="tab2"]').addClass('active').siblings('[data-tab^="tab"]').removeClass('active');
			$('.tab-indicator').css({ width: '55.2188px', transform: 'translateX(95.5312px)' });
			break;
		case "3": // 완료
			$('[data-tab="tab3"]').addClass('active').siblings('[data-tab^="tab"]').removeClass('active');
			$('.tab-indicator').css({ width: '55.2188px', transform: 'translateX(191.062px)' });
			break;
		case "4": // 반려
			$('[data-tab="tab4"]').addClass('active').siblings('[data-tab^="tab"]').removeClass('active');
			$('.tab-indicator').css({ width: '25.9375px', transform: 'translateX(191.062px)' });
			break;
	}
	
});

// 문서 유형
function docFormNo(data) {
	switch (data) {
		case '1':
			return "품의서";
		case '2':
			return "출장신청서";
		case '3':
			return "도서구입신청서";
		default:
			break;
	}
}

// 결재 대기
function getTabData1(tab) {

	$.ajax({
		url: `/approval/listView/${tab}`,
		type: "GET",
		dataType: "json",
		success: function (result) {

			console.log("결재 대기 -> ", result);
			
			const $tbody = $('.tab-content1').find('tbody');
            $tbody.empty();

			if (Array.isArray(result) && result.length > 0) {
				result.map((e, i) => {

					let docType = docFormNo(e.docFormNo);

					let HTML = `
						<tr data-apv-no='${e.apvNo}'>
							<td>${i + 1}</td>
							<td>${docType}</td>
							<td>${e.apvSj}</td>
							<td>${e.empNm}</td>
							<td>${e.apvPosition}/${e.apvRspnsbl}</td>
							<td>${e.deptNm}</td>
							<td>${e.drftDate}</td>
						</tr>		
					`;

					$('.tab-content1').find('tbody').append(HTML);
				});

			} else {
				let HTML = noDate();
				$('.tab-content1').find('tbody').append(HTML);
			}
		}
	});
}

// 결재 진행
function getTabData2(tab) {

	$.ajax({
		url: `/approval/listView/${tab}`,
		type: "GET",
		dataType: "json",
		success: function (result) {

			console.log("결재 진행 -> ", result);
			
			const $tbody = $('.tab-content2').find('tbody');
            $tbody.empty();

			if (Array.isArray(result) && result.length > 0) {
				result.map((e, i) => {

					let docType = docFormNo(e.docFormNo);

					let HTML = `
						<tr data-apv-no='${e.apvNo}'>
							<td>${i + 1}</td>
							<td>${docType}</td>
							<td>${e.apvSj}</td>
							<td>${e.empNm}</td>
							<td>${e.apvPosition}/${e.apvRspnsbl}</td>
							<td>${e.deptNm}</td>
							<td>${e.drftDate}</td>
						</tr>		
					`;

					$('.tab-content2').find('tbody').append(HTML);
				});

			} else {
				let HTML = noDate();
				$('.tab-content2').find('tbody').append(HTML);
			}
		}
	});
}

// 결재 완료
function getTabData3(tab) {

	$.ajax({
		url: `/approval/listView/${tab}`,
		type: "GET",
		dataType: "json",
		success: function (result) {
			console.log("결재완료 -> ", result);
			
			const $tbody = $('.tab-content3').find('tbody');
            $tbody.empty();

			if (Array.isArray(result) && result.length > 0) {
				result.map((e, i) => {

					let docType = docFormNo(e.docFormNo);

					let HTML = `
						<tr data-apv-no='${e.apvNo}'>
							<td>${i + 1}</td>
							<td>${docType}</td>
							<td>${e.apvSj}</td>
							<td>${e.empNm}</td>
							<td>${e.apvPosition}/${e.apvRspnsbl}</td>
							<td>${e.deptNm}</td>
							<td>${e.drftDate}</td>
							<td>${e.apvDate}</td>
						</tr>		
					`;

					$('.tab-content3').find('tbody').append(HTML);
				});
			}
			else {
				let HTML = noDate();
				$('.tab-content3').find('tbody').append(HTML);
			}
		}
	});

}

// 반려
function getTabData4(tab) {

	$.ajax({
		url: `/approval/listView/${tab}`,
		type: "GET",
		dataType: "json",
		success: function (result) {
			console.log("반려 -> ", result);

			if (Array.isArray(result) && result.length > 0) {
				result.map((e, i) => {

					let docType = docFormNo(e.docFormNo);

					let HTML = `
						<tr data-apv-no='${e.apvNo}'>
							<td>${i + 1}</td>
							<td>${docType}</td>
							<td>${e.apvSj}</td>
							<td>${e.drftDate}</td>
							<td>${e.refuseDate}</td>
						</tr>		
					`;
					$('.tab-content4').find('tbody').append(HTML);
				});
			}
			else {
				let HTML = noDate();
				$('.tab-content4').find('tbody').append(HTML);
			}
		}
	});
}

// 회수
function getTabData5(tab) {

	$.ajax({
		url: `/approval/listView/${tab}`,
		type: "GET",
		dataType: "json",
		success: function (result) {
			console.log("회수 -> ", result);

			if (Array.isArray(result) && result.length > 0) {
				result.map((e, i) => {
					let docType = docFormNo(e.docFormNo);

					let HTML = `
						<tr data-apv-no='${e.apvNo}'>
							<td>${i + 1}</td>
							<td>${docType}</td>
							<td>${e.apvSj}</td>
							<td>${e.drftDate}</td>
							<td>
								<a href="javascript:void(0)" style="padding: 5px 20px;" class="btn7">재기안</a>
								<a href="javascript:void(0)" style="padding: 5px 20px;" class="btn5">삭제</a>
							</td>
						</tr>		
					`;

					$('.tab-content5').find('tbody').append(HTML);
				});
			}
			else {
				let HTML = noDate();
				$('.tab-content5').find('tbody').append(HTML);
			}
		}
	});
}

// 임시 저장함
function getTabData6(tab) {

	$.ajax({
		url: `/approval/listView/${tab}`,
		type: "GET",
		dataType: "json",
		success: function (result) {
			console.log("임시 저장함 -> ", result);

			if (Array.isArray(result) && result.length > 0) {
				result.map((e, i) => {
					let docType = docFormNo(e.docFormNo);

					let HTML = `
						<tr data-apv-no='${e.apvNo}'>
							<td>${i + 1}</td>
							<td></td>
							<td></td>
							<td></td>
							<td>
								<a href="javascript:void(0)" style="padding: 5px 20px;" class="btn7">재기안</a>
								<a href="javascript:void(0)" style="padding: 5px 20px;" class="btn5">삭제</a>
							</td>
						</tr>		
					`;

					$('.tab-content6').find('tbody').append(HTML);
				});
			}
			else {
				let HTML = noDate();
				$('.tab-content6').find('tbody').append(HTML);
			}
		}
	});
}

// 데이터 없을 경우
function noDate() {
	return `<tr><td colspan='7' style="text-align: center;">문서가 없습니다.</td></tr>`;
}

// 상세 조회
$(document).on('click', '.wf-table tbody tr', function () {

	let apvNo = $(this).data('apvNo');

	$.ajax({
		url: '/approval/approvalDetailView?apvNo=' + apvNo,
		type: 'get',
		dataType: 'text',
		success: function () {

			location.href =
				"/approval/approvalDetailView?apvNo=" + apvNo;

		}
	});

});

